#!/bin/bash
#
#
#############################################################################
#author       :    fushikai
#date         :    20190519
#linux_version:    Red Hat Enterprise Linux Server release 6.7
#dsc          :
#       Wind power prediction system 2.0linux system software firewall 
#       configuration file template
#
#    
#revision history:
#       v0.0.0.1  @ 20190723
#       2019-09-23 modify v0.0.0.1 version to V20.01.000
#       
#    高龙山重新用新版本iptables脚本配置 @ 2021-03-05
#
#############################################################################



#此值判断文件是否已经加载，修改配置文件此不用修改此值
[ ! -z "${Already_loadedCfg_Flag}" ] && return 0
Already_loadedCfg_Flag=1




###############################################################
#           主机名配置区域  
#   可以在服务器上打开终端执行: echo $HOSTNAME 得到
#   2.0系统的主机名在装系统时是固定的，一般不需要修改
###############################################################

#MY_HOSTNAME="fuskTest"          #要操作的服务器名傅世凯测试用的

MS_HOSTNAME="MeteoServer"          #气象服务器
PS1_HOSTNAME="PredictServer1"     #主预测服务器
PS2_HOSTNAME="PredictServer2"     #备预测服务器    
SCA_HOSTNAME="ScadaServer"        #scada预测服务器 
WK_HOSTNAME="WorkStation"          #工作站    





###############################################################
#           
#   调试总开关及可定制功能区域
#  
###############################################################

#debugFlag=1 只输出将要配置的信息不实际写入系统；其他值则执行系统配置
debugFlag=0

#enablePing=1 开启ping功能,0关闭ping功能
enablePing=1

#enInterSsh=1 开启内网的ssh端口
enInterSsh=1

#bindNICByIP=1 根据配置的ip自动找对应的网卡号并进行绑定;0则不绑定
bindNICByIP=1



###############################################################
#           
#此脚本支持规则功能定义区域：【注】此区域建议不要修改除非软件升级 
#  
###############################################################

#outPrtFlag:产生规则的标识       0:OUTPUT,INPUT; 1:OUTPUT; 2:INPUT                 
prtAll=0
prtIn=2
prtOut=1

#server_opFlag:在连接状中是作为client还是server   0:client; 1:server; 2:client,server; 3:stat null
srvOp_client=0
srvOp_server=1
srvOp_all=2
srvop_null=3

#op_protocol:所用协议标识        tcp,upd,all
op_tcp="tcp"
op_udp="udp"
op_all="all"


#################################################################################
#
#                  **********各主机配置配置规则区域**********
#
#################################################################################
#
#
# 配置规则简要说明
#####################################
#    配置中凡是端口的配置都遵循的规则：
#    --------------------------------------------->
#    (1)可配单个端口号
#    (2)可配连续的端口号但需要用-线连接如 1024-65535
#    (3)可配多个不连接端口号用，号分隔如 20,21,1024-65535
#    <---------------------------------------------
#
#
#    配置配置条目时要遵循的规则：
#    --------------------------------------------->
#    所有的最终要用英文输入法中半角状态的双引号"括起来
#           每个条目的基本格式为: ${prtAll}/${srvOp_client}/${op_tcp}/网卡号/local_addr/remoteaddr
#           多个条目用 | 隔开，中间可以有换行或空格
#          
#          每个ip后如果有端口号则格式为 "ip:端口"
#          如果端口号是一个范围则配置为 "ip:端口1-端口2"
#          ip地址对中可以只有端口号但端口号之前的:不能省略
#    
#    <---------------------------------------------
#####################################

 
##################################################
#                                                #
#             日志审查,2区校时用的ip及端口       #
#                                                #
#                                                #
##################################################
#
ssh_port=22             #ssh连接端口
ssh_ctPort="1024-65535" #ssh客户端端口
TIME_PORT=6801-6809    #校时服务使用的端口号,如果是固定的也可写成固定端口
DC_PORT=9009           #数据中心软件使用的监听端口
WEB_PORT=8080          #JAVA平台软件使用的监听端口

AUDIT_Log_IP=100.110.120.50    #日志审计、网络安全管理等审计功能使用的IP
#AUDIT_LOG_PORT=8800      #日志审计、网络安全管理等审计功能使用的端口,如果是固定的也可写成固定端口
#AUDIT_LOG_PORT=1024-65535      #日志审计、网络安全管理等审计功能使用的端口,如果是固定的也可写成固定端口

SAGENT_IP="100.110.120.100" #网安之类的
SAGENT_PORT=8800





##################################################
#                                                #
#             气象服务器配置                     #
#                                                #
#                                                #
##################################################
#

qx_local_fg_ip1="10.1.1.10"             #气象本地反隔ip1
qx_local_fg_ip2="10.1.2.10"            #气象本地反隔ip2  
qx_local_extranet_ip="192.168.1.181"    #气象本地联外网的Ip
qx_ftp_server_ip1="42.121.65.50"        #气象ftp远程ip1
qx_ftp_server_ip2="182.254.227.250"          #气象ftp远程ip2

qx_fg_NIC_name1="p2p1"                   #气象反隔网卡号1
qx_fg_NIC_name2="p2p2"                   #气象反隔网卡号2 

cfg_rule_items_qx="
    ${prtAll}/${srvop_null}/${op_udp}//${qx_local_extranet_ip}/:123
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1}:21
 |  ${prtAll}/${srvOp_server}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1}:20
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1}:1024-65535
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip2}:21
 |  ${prtAll}/${srvOp_server}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip2}:20
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip2}:1024-65535
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1},${qx_ftp_server_ip2}:${ssh_port}
 |  ${prtAll}/${srvOp_client}/${op_all}/${qx_fg_NIC_name1}//
 |  ${prtAll}/${srvOp_client}/${op_all}/${qx_fg_NIC_name2}//
"




##################################################
#                                                #
#             各服务内网互通ip                   #
#                                                #
#                                                #
##################################################
#

scada_local_intranet_ip="100.110.120.30"  #scada内部网络ip 
ps1_local_intranet_ip="100.110.120.20"    #主预测内部网络ip
ps2_local_intranet_ip="100.110.120.10"    #备预测内部网络ip
wk_local_intranet_ip="100.110.120.40"     #工作站内部网络ip

ssh_port=22             #ssh连接端口
database_port=1521      #数据库访问端口



##################################################
#                                                #
#             SCADA 服务器配置                   #
#                                                #
#                                                #
##################################################
#

##|${prtAll}/${srvOp_server}/${op_tcp}//198.123.0.1:2404/198.123.0.200
##| ${prtAll}/${srvOp_client}/${op_tcp}//198.124.0.1:1024-65535/198.124.0.200

cfg_local_ip="100.110.120.30"   #采集测风塔本地ip
cfg_remote_ip="100.110.120.30"  #采集测风塔远程ip 通过DataAcquisition程序本地转的

zf_cfglcal_ip="198.122.0.1"     #DataAcquisition转发测风塔数据给远动本地ip
zf_cfgrmt_ip="198.122.0.200"    #DataAcquisition转发测风塔数据给远动对应远动ip

fj_local_ip="193.122.0.101"     #采集风机数据本地ip
fj_remote_ip="193.122.0.10"     #采集风机数据对应风机器ip

frm_local_ip="198.124.0.1"      #接收远动整场本地ip
frm_remote_ip="198.124.0.200"   #接收远动整场对端ip

zf_tpslcal_ip="198.123.0.1"     #转发理论功率本地ip
zf_tpsrmt_ip="198.123.0.200"    #转发理论功率对端ip

fj2_local_ip="194.100.100.3"     #采集风机2期数据本地ip
fj2_remote_ip="194.100.100.1"    #采集风机2期数据对应风机器ip

cft2_local_ip="192.168.10.20"     #采集测风塔2期数据本地ip
cft2_remote_ip="192.168.10.100"    #采集测风塔2期数据对应测风塔ip
cft2_remote_port="5002"           #采集测风塔2期数据对应测风塔端口号


cfg_rule_items_scada="
   ${prtAll}/${srvOp_client}/${op_tcp}//${scada_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${DC_PORT}
  |${prtAll}/${srvop_null}/${op_tcp}//${scada_local_intranet_ip}:${TIME_PORT}/${ps1_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${TIME_PORT}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${zf_cfglcal_ip}:502/${zf_cfgrmt_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${fj_local_ip}/${fj_remote_ip}:5020
  | ${prtAll}/${srvOp_client}/${op_tcp}//${fj2_local_ip}/${fj2_remote_ip}:504
  | ${prtAll}/${srvOp_client}/${op_tcp}//${cft2_local_ip}/${cft2_remote_ip}:${cft2_remote_port}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${frm_local_ip}/${frm_remote_ip}:2404
  | ${prtAll}/${srvOp_server}/${op_tcp}//${zf_tpslcal_ip}:2404/${zf_tpsrmt_ip}
  | ${prtAll}/${srvop_null}/${op_all}//${scada_local_intranet_ip}/${AUDIT_Log_IP}
  | ${prtAll}/${srvop_null}/${op_tcp}//${scada_local_intranet_ip}/${SAGENT_IP}:${SAGENT_PORT}
"

cfg_rule_ssh_scada="
     ${prtAll}/${srvOp_server}/${op_tcp}//${scada_local_intranet_ip}:${ssh_port}/${ps1_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}
     |${prtAll}/${srvOp_client}/${op_tcp}//${scada_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${ssh_port}
"



##################################################
#                                                #
#             预测主服务器配置  测试主机         #
#                                                #
#                                                #
##################################################
#

upload_remote_ips="10.36.131.1,10.36.131.2,36.10.27.1,36.10.27.2" #上传省调的ip
ps1_upload_localip="36.100.155.169"      #预测主上传时本地Ip    

upload_local_sftp="192.168.1.85"               #上传sftp本地ip
upload_remote_sftp="10.10.10.10,10.10.20.10"   #上传sftp对端ip 


web_port="${WEB_PORT}"           #web访问的端口
datacenter_port="${DC_PORT}"      #数据库访问端口
ps1_fg_NIC_name1="eth0"                   #预测主反隔网卡号

#
#


cfg_rule_items_ps1="
    ${prtAll}/${srvOp_server}/${op_all}/${ps1_fg_NIC_name1}//
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_upload_localip}:3000/${upload_remote_ips}   
  | ${prtAll}/${srvOp_client}/${op_tcp}//${upload_local_sftp}/${upload_remote_sftp}:22
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${web_port}/${wk_local_intranet_ip}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${datacenter_port}/${wk_local_intranet_ip},${ps2_local_intranet_ip},${scada_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps1_local_intranet_ip}/${ps2_local_intranet_ip}:${datacenter_port}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${database_port}/${ps2_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps1_local_intranet_ip}/${ps2_local_intranet_ip}:${database_port}
  | ${prtAll}/${srvop_null}/${op_tcp}//${ps1_local_intranet_ip}:${TIME_PORT}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${TIME_PORT}
  | ${prtAll}/${srvop_null}/${op_all}//${ps1_local_intranet_ip}/${AUDIT_Log_IP}
  | ${prtAll}/${srvop_null}/${op_tcp}//${ps1_local_intranet_ip}/${SAGENT_IP}:${SAGENT_PORT}
"

cfg_rule_ssh_ps1="
     ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${ssh_port}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}
     |${prtAll}/${srvOp_client}/${op_tcp}//${ps1_local_intranet_ip}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${ssh_port}
"

##################################################
#                                                #
#             预测备服务器配置                   #
#                                                #
#                                                #
##################################################
#

###注意此机器 备机暂时未用如果启用则需要重新配置如下规则

ps2_fg_NIC_name1="p1p1"                   #预测备反隔网卡号
#
ps2_upload_localip="10.67.129.203"      #预测备上传时本地Ip
ps2_upload_local_sftp="192.168.1.85"               #上传sftp本地ip

cfg_rule_items_ps2="
    ${prtAll}/${srvOp_server}/${op_all}/${ps2_fg_NIC_name1}//
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_upload_localip}:3000/${upload_remote_ips}   
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_upload_local_sftp}/${upload_remote_sftp}:22
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${web_port}/${wk_local_intranet_ip}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${datacenter_port}/${wk_local_intranet_ip},${ps1_local_intranet_ip},${scada_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_local_intranet_ip}/${ps1_local_intranet_ip}:${datacenter_port}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${database_port}/${ps1_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_local_intranet_ip}/${ps1_local_intranet_ip}:${database_port}
  | ${prtAll}/${srvop_null}/${op_tcp}//${ps2_local_intranet_ip}:${TIME_PORT}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_local_intranet_ip}:${TIME_PORT}
  | ${prtAll}/${srvop_null}/${op_all}//${ps2_local_intranet_ip}/${AUDIT_Log_IP}
  | ${prtAll}/${srvop_null}/${op_tcp}//${ps2_local_intranet_ip}/${SAGENT_IP}:${SAGENT_PORT}
"

cfg_rule_ssh_ps2="
     ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${ssh_port}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_local_intranet_ip}
     |${prtAll}/${srvOp_client}/${op_tcp}//${ps2_local_intranet_ip}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_local_intranet_ip}:${ssh_port}
"


##################################################
#                                                #
#             工作站服务器配置                   #
#                                                #
#                                                #
##################################################
#

cfg_rule_items_wk="
    ${prtAll}/${srvOp_client}/${op_tcp}//${wk_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${web_port}
  | ${prtAll}/${srvop_null}/${op_tcp}//${wk_local_intranet_ip}:${TIME_PORT}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${ps1_local_intranet_ip}:${TIME_PORT}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${wk_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${datacenter_port}
  | ${prtAll}/${srvop_null}/${op_all}//${wk_local_intranet_ip}/${AUDIT_Log_IP}
  | ${prtAll}/${srvop_null}/${op_tcp}//${wk_local_intranet_ip}/${SAGENT_IP}:${SAGENT_PORT}
"
cfg_rule_ssh_wk="
     ${prtAll}/${srvOp_server}/${op_tcp}//${wk_local_intranet_ip}:${ssh_port}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${ps2_local_intranet_ip}
     |${prtAll}/${srvOp_client}/${op_tcp}//${wk_local_intranet_ip}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${ssh_port}
"


###############################################################
###############################################################

