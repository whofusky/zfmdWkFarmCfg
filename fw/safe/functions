#
#      File: functions
# Create on: 2019-01-08
#    Author: Sunjianjun/QQ37489753/WeChat:fatsunabc/Email:sunsjj@126.com
#  Function: Firewall functions library.
#   Version: 1.0
# Revision History:
#   2019-01-08    Created by SunJianjun.
#

. $PWD/network.conf

# 
function ECHO_DO()
{
  cmd=$*  
  echo "[$USER@$HOSTNAME $PWD] $cmd"
  $cmd
}

function FW_START()
{
  ECHO_DO chkconfig iptables on
  ECHO_DO service iptables start
}

function FW_STOP()
{
  ECHO_DO service iptables stop
  ECHO_DO chkconfig iptables off
}

function FW_SAVE()
{
  ECHO_DO /etc/rc.d/init.d/iptables save
  ECHO_DO service iptables restart
}

function FW_VIEW()
{
  ECHO_DO iptables -L -n -v
}

function FW_CLEAR()
{
  ECHO_DO iptables -F
  ECHO_DO iptables -X
  ECHO_DO iptables -F -t mangle
  ECHO_DO iptables -t mangle -X
  ECHO_DO iptables -F -t nat
  ECHO_DO iptables -t nat -X
  ECHO_DO iptables -P INPUT DROP
  ECHO_DO iptables -P OUTPUT DROP
  ECHO_DO iptables -P FORWARD ACCEPT
}

function FW_LO()
{
  ECHO_DO iptables -A INPUT -i lo -p all -j ACCEPT
  ECHO_DO iptables -A OUTPUT -o lo -p all -j ACCEPT
}

function FW_PING()
{
  ECHO_DO iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
  ECHO_DO iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
  ECHO_DO iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
  ECHO_DO iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
}

function FW_INIT()
{
  FW_START
  FW_CLEAR
  FW_LO
  FW_PING
}

# FW_TCP_OUT(local_ip, remote_ip, remote_port)
function FW_TCP_OUT()
{
  ECHO_DO iptables -A OUTPUT -d $2 -s $1 -p tcp --dport $3 -m state --state NEW,ESTABLISHED -j ACCEPT
  ECHO_DO iptables -A INPUT -s $2 -d $1 -p tcp --sport $3 -m state --state ESTABLISHED -j ACCEPT
}

# FW_TCP_OUT_R(remote_ip, remote_port)
function FW_TCP_OUT_R()
{
  ECHO_DO iptables -A OUTPUT -d $1 -p tcp --dport $2 -m state --state NEW,ESTABLISHED -j ACCEPT
  ECHO_DO iptables -A INPUT -s $1 -p tcp --sport $2 -m state --state ESTABLISHED -j ACCEPT
}

# FW_TCP_IN(local_ip, local_port, remote_ip)
function FW_TCP_IN()
{
  ECHO_DO "iptables -A INPUT -s $3 -d $1 -p tcp --dport $2 -m state --state NEW,ESTABLISHED -j ACCEPT"
  ECHO_DO "iptables -A OUTPUT -d $3 -s $1 -p tcp --sport $2 -m state --state ESTABLISHED -j ACCEPT"
}

# FW_TCP_IN_P(local_port)
function FW_TCP_IN_P()
{
  ECHO_DO "iptables -A INPUT -p tcp --dport $1 -m state --state NEW,ESTABLISHED -j ACCEPT"
  ECHO_DO "iptables -A OUTPUT -p tcp --sport $1 -m state --state ESTABLISHED -j ACCEPT"
}

# FW_TCP_EACHOTHER(local_ip, remote_ip, port)
function FW_TCP_EACHOTHER()
{
  ECHO_DO "iptables -A INPUT -s $2 -d $1 -p tcp --sport $3 --dport $3 -m state --state NEW,ESTABLISHED -j ACCEPT"
  ECHO_DO "iptables -A OUTPUT -d $2 -s $1 -p tcp --sport $3 --dport $3 -m state --state NEW,ESTABLISHED -j ACCEPT"
}

# FW_UDP_OUT(local_ip, remote_ip)
function FW_UDP_OUT()
{
  ECHO_DO "iptables -A OUTPUT -d $2 -s $1 -p udp -j ACCEPT"
}

# FW_UDP_NTP()
function FW_UDP_NTP()
{
  ECHO_DO "iptables -A OUTPUT -p udp --dport 123 -j ACCEPT"
  ECHO_DO "iptables -A INPUT -p udp --sport 123 -j ACCEPT"
}

# FW_NIC_IN(nic)
function FW_NIC_IN()
{
  ECHO_DO iptables -A INPUT -i $1 -p all -m state --state NEW,ESTABLISHED -j ACCEPT
  ECHO_DO iptables -A OUTPUT -o $1 -p all -m state --state ESTABLISHED -j ACCEPT
}

# FW_NIC_OUT(nic)
function FW_NIC_OUT()
{
  ECHO_DO iptables -A OUTPUT -o $1 -p all -m state --state NEW,ESTABLISHED -j ACCEPT
  ECHO_DO iptables -A INPUT -i $1 -p all -m state --state ESTABLISHED -j ACCEPT
}
