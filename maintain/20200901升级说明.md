
# 升级经历时间段
2020-09-02 至 2020-09-03

# 升级背景
省调收不到理论功率 可用功率 实发功率 开机容量 限电标记五个数据(此数据是风功率预测
用104协议通过scada的通道3转发给远动,然后远动传给省调)
经查远动是15分钟进行一次总召数据,但同时scada的通道3即给远动传输的数据没有进行突发
用户要求需要进行升级程序需要有正常的数据突发.

# 历史原因
现场的scada版本是18年部署的版本,版本很老旧且找不到源码.

# 最后决定
升级scada到2.0的最新版本

# 关联影响
scada的did库最近有一次变动,二进制导出字符从原来的22位升级成34位,因此关联到数据
中心,短期入库程序,上传也需要进行升级

# 升级过程简要记录
2020-09-02 
    上午
       1. 开始协助现场场站人员进行操作升级,最开始升级提数据中心等程序
       2. 然后进行scada程序包的升级.
       3. scad升级后发现通道2报有一个无用的空点找不到的错(不影响正常处理,后添加一个16493空点解决)
       4. 监控软件和scad升级后发现与数据中心通信报-115的错误,最开始是数据中心问题.一直快中午了
          开始排除是scada与数据中心的网络问题
    中午
       1. 查网络问题,ping不通预测主,nc预测主9009端口不通,怀疑是现场动网络等问题
    下午 
       1. 发现是现场防火墙规则的问题,升级前程序好使是因为,升级前scada与数据中心通信
          本地只用了两个端口,入库5406,出库5407;所以防火墙只放行了这两个端口,所以
          新scada和监控程序才会报错(升级之前监控程序是不好使的)
       2. 通过修改/etc/sysconfig/iptables文件使scada与监控程序可以与数据中心通信
       3. 网络通信解决以后,发现通道3(转发数据到远程)的通道接收不到远程的召唤,导致
          scada与远程无数据传输(测试环境测不出这种问题)
    晚上
       1. 通过现场tcpdump抓包程序分析后得出结论,socket联接能建立,但scada没有反应(没有报文日志)
       2. 修改scadas的socket头文件程序使其可以打印日志,并且根据推断把可能的原因再次close socket
          的地方加上millsleep 500,然其在测试环境运行一晚上
2020-09-03
    上午
       1. 将版本v10.040.040升级到现场观察,问题依旧存在,但从日志可以看出,socket监听
          处根据收不到epoll事件(但socket确实是能建立连接)
    中午
       1. 继续排查程序问题
    下午
       1. 继续排查程序问题无果,高工提出一个可能可行的方案找一个端口转发工具接收远动
          的请求,然后再转发给scada.
       2. 找到rinetd转发工具进行测试然后修改scada的监听端口为2405发布版本v10.040.050
       3. 现场问题解决
    晚上
       1.帮着修改现场反隔升级等程序的自启动,以及网安要求的防火墙新规则添加

          

